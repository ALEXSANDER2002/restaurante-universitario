<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard com Pesquisa</title>
    <link rel="stylesheet" href="/public/CSS/style.css">
    <style>
        .dashboard-container {
            margin: 50px auto;
            width: 90%;
            max-width: 1200px;
            text-align: center;
        }

        .dashboard-container h1 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: bold;
        }

        .search-container {
            margin-bottom: 20px;
            text-align: right;
        }

        .search-container input {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 250px;
            transition: border-color 0.3s ease;
        }

        .search-container input:focus {
            border-color: #2e7d32;
            outline: none;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #f4f4f4;
            color: #333;
            font-size: 16px;
            text-transform: uppercase;
        }

        table td {
            color: #555;
            font-size: 14px;
        }

        table tr:hover {
            background-color: #f9f9f9;
        }

        .action-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 35px;
            height: 35px;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease;
        }

        .action-btn:hover {
            transform: scale(1.1);
            background-color: #45a049;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 300px;
            max-width: 80%;
            display: none;
        }

        .modal.visible {
            display: block;
        }

        .modal-content {
            text-align: center;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: red;
        }

        .close-order-btn {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }

        .close-order-btn:hover {
            background: #b71c1c;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                width: 95%;
            }

            table th,
            table td {
                padding: 10px;
            }

            .action-btn {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <header>
        <img src="/public/IMG/logo.png" alt="UNIFESSPA">
        <!-- <div class="profile" id="profile-menu-toggle">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/Default_pfp.svg/600px-Default_pfp.svg.png" alt="Minha Conta">
            <span>Minha Conta</span>
        </div> -->
    </header>

    <div class="dashboard-container">
        <h1>Dashboard</h1>
        <div class="search-container">
            <input type="text" id="search-bar" placeholder="Digite para pesquisar...">
        </div>
        <div class="table-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>N¬∞</th>
                        <th>Nome</th>
                        <th>Matr√≠cula</th>
                        <th>Campus</th>
                        <th>Tipo de Comida</th>
                        <th>Data e Hora</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="close-modal">&times;</span>
            <h3>Detalhes do Pedido</h3>
            <p><strong>N√∫mero:</strong> <span id="modal-numero"></span></p>
            <p><strong>Nome:</strong> <span id="modal-nome"></span></p>
            <p><strong>Matr√≠cula:</strong> <span id="modal-matricula"></span></p>
            <p><strong>Campus:</strong> <span id="modal-campus"></span></p>
            <p><strong>Tipo de Comida:</strong> <span id="modal-comida"></span></p>
            <p><strong>Data e Hora:</strong> <span id="modal-data"></span></p> 
            <button id="close-order" class="close-order-btn" data-id="">Fechar Pedido</button>
        </div>
    </div>
    <footer class="footer">
        <div>
            <h2>Alimenta√ß√£o</h2>
            <p>Gest√£o eficiente de tickets de alimenta√ß√£o universit√°ria.</p>
            <div class="social-icons">
                <a href="https://www.facebook.com/" target="blank" rel="noopener" title="Go to Facebook page" class="social-icons_link" data-v-17c99e7b=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M24 12.0726C24 5.44354 18.629 0.0725708 12 0.0725708C5.37097 0.0725708 0 5.44354 0 12.0726C0 18.0619 4.38823 23.0264 10.125 23.9274V15.5414H7.07661V12.0726H10.125V9.4287C10.125 6.42144 11.9153 4.76031 14.6574 4.76031C15.9706 4.76031 17.3439 4.99451 17.3439 4.99451V7.94612H15.8303C14.34 7.94612 13.875 8.87128 13.875 9.82015V12.0726H17.2031L16.6708 15.5414H13.875V23.9274C19.6118 23.0264 24 18.0619 24 12.0726Z" fill="currentColor"></path></svg></a>
            </div>
            <div class="social-icons">
                <a href="https://www.instagram.com/" target="blank" rel="noopener" title="Go to Instagram page" class="social-icons_link" data-v-17c99e7b=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.0027 5.84808C8.59743 5.84808 5.85075 8.59477 5.85075 12C5.85075 15.4053 8.59743 18.1519 12.0027 18.1519C15.4079 18.1519 18.1546 15.4053 18.1546 12C18.1546 8.59477 15.4079 5.84808 12.0027 5.84808ZM12.0027 15.9996C9.80212 15.9996 8.00312 14.2059 8.00312 12C8.00312 9.7941 9.79677 8.00046 12.0027 8.00046C14.2086 8.00046 16.0022 9.7941 16.0022 12C16.0022 14.2059 14.2032 15.9996 12.0027 15.9996ZM19.8412 5.59644C19.8412 6.39421 19.1987 7.03135 18.4062 7.03135C17.6085 7.03135 16.9713 6.38885 16.9713 5.59644C16.9713 4.80402 17.6138 4.16153 18.4062 4.16153C19.1987 4.16153 19.8412 4.80402 19.8412 5.59644ZM23.9157 7.05277C23.8247 5.13063 23.3856 3.42801 21.9775 2.02522C20.5747 0.622429 18.8721 0.183388 16.9499 0.0870135C14.9689 -0.0254238 9.03112 -0.0254238 7.05008 0.0870135C5.1333 0.178034 3.43068 0.617075 2.02253 2.01986C0.614389 3.42265 0.180703 5.12527 0.0843279 7.04742C-0.0281093 9.02845 -0.0281093 14.9662 0.0843279 16.9472C0.175349 18.8694 0.614389 20.572 2.02253 21.9748C3.43068 23.3776 5.12794 23.8166 7.05008 23.913C9.03112 24.0254 14.9689 24.0254 16.9499 23.913C18.8721 23.822 20.5747 23.3829 21.9775 21.9748C23.3803 20.572 23.8193 18.8694 23.9157 16.9472C24.0281 14.9662 24.0281 9.03381 23.9157 7.05277ZM21.3564 19.0728C20.9388 20.1223 20.1303 20.9307 19.0755 21.3537C17.496 21.9802 13.7481 21.8356 12.0027 21.8356C10.2572 21.8356 6.50396 21.9748 4.92984 21.3537C3.88042 20.9361 3.07195 20.1276 2.64897 19.0728C2.02253 17.4934 2.16709 13.7455 2.16709 12C2.16709 10.2546 2.02789 6.50129 2.64897 4.92717C3.06659 3.87776 3.87507 3.06928 4.92984 2.6463C6.50931 2.01986 10.2572 2.16443 12.0027 2.16443C13.7481 2.16443 17.5014 2.02522 19.0755 2.6463C20.1249 3.06392 20.9334 3.8724 21.3564 4.92717C21.9828 6.50665 21.8383 10.2546 21.8383 12C21.8383 13.7455 21.9828 17.4987 21.3564 19.0728Z" fill="currentColor"></path></svg></a>
            </div>
            <div class="social-icons">
                <a href="https://tiktok.com" target="blank" rel="noopener" title="Go to Tiktok page" class="social-icons_link" data-v-17c99e7b=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.5 9.84202C20.4357 9.84696 18.4221 9.20321 16.7435 8.00171V16.3813C16.7429 17.9333 16.2685 19.4482 15.3838 20.7233C14.499 21.9984 13.246 22.973 11.7923 23.5168C10.3387 24.0606 8.75362 24.1477 7.24914 23.7664C5.74466 23.3851 4.39245 22.5536 3.37333 21.383C2.3542 20.2125 1.71674 18.7587 1.54617 17.2161C1.3756 15.6735 1.68007 14.1156 2.41884 12.7507C3.15762 11.3858 4.2955 10.279 5.68034 9.57823C7.06517 8.87746 8.63095 8.61616 10.1683 8.82927V13.0439C9.46481 12.8227 8.70938 12.8293 8.0099 13.063C7.31041 13.2966 6.70265 13.7453 6.2734 14.345C5.84415 14.9446 5.61536 15.6646 5.6197 16.402C5.62404 17.1395 5.8613 17.8567 6.29759 18.4512C6.73387 19.0458 7.34688 19.4873 8.04906 19.7127C8.75125 19.9381 9.5067 19.9359 10.2075 19.7063C10.9084 19.4768 11.5188 19.0316 11.9515 18.4345C12.3843 17.8374 12.6173 17.1188 12.6173 16.3813V0H16.7435C16.7406 0.348435 16.7698 0.696395 16.8307 1.03948C16.9741 1.80537 17.2722 2.53396 17.7068 3.18068C18.1415 3.8274 18.7035 4.37867 19.3585 4.80075C20.2903 5.41688 21.3829 5.74528 22.5 5.74505V9.84202Z" fill="currentColor"></path>
                </svg></a>
            </div>
            <div class="social-icons">
                <a href="https://x.com/" target="blank" rel="noopener" title="Go to Twitter page" class="social-icons_link" data-v-17c99e7b=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18.244 2.25H21.552L14.325 10.51L22.827 21.75H16.17L10.956 14.933L4.99003 21.75H1.68003L9.41003 12.915L1.25403 2.25H8.08003L12.793 8.481L18.244 2.25ZM17.083 19.77H18.916L7.08403 4.126H5.11703L17.083 19.77Z" fill="currentColor"></path>
                </svg></a>
            </div>
    
        </div>
    
    
        <div>
            <h3>Suporte</h3>
            <p>+55 4002-8922</p>
            <p>contato@universitario.com</p>
        </div>
        <div class="contact">
            <h3>Contato</h3>
            <input type="email" placeholder="Seu e-mail para contato">
            <button>Enviar solicita√ß√£o de ingresso</button>
        </div>
    </footer>

    <script>
        async function carregarTodosOsPedidos() {
            try {
                console.log("üîç Buscando todos os pedidos...");
    
                const response = await fetch(`http://localhost:3000/buy/compras-todos`);
    
                if (!response.ok) {
                    throw new Error(`Erro na requisi√ß√£o: ${response.status} ${response.statusText}`);
                }
    
                const compras = await response.json();
                console.log("üì¶ Todos os pedidos recebidos:", compras);
    
                const tbody = document.querySelector("#data-table tbody");
                tbody.innerHTML = ""; // Limpa a tabela antes de adicionar os novos pedidos
    
                compras.forEach(compra => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${compra.id}</td>
                        <td>${compra.usuario_nome}</td>
                        <td>${compra.matricula}</td>
                        <td>${compra.campus}</td>
                        <td>${compra.tipo_comida}</td>
                        <td>${new Date(compra.created_at).toLocaleString("pt-BR")}</td>
                        <td>
                            <button class="action-btn"
                                data-id="${compra.id}"
                                data-name="${compra.usuario_nome}"
                                data-matricula="${compra.matricula}"
                                data-campus="${compra.campus}"
                                data-comida="${compra.tipo_comida}"
                                data-date="${compra.created_at}">üîç</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
    
                document.getElementById("search-bar").addEventListener("input", function() {
            const searchText = this.value.toLowerCase();
            document.querySelectorAll("#data-table tbody tr").forEach(row => {
                const rowText = row.textContent.toLowerCase();
                row.style.display = rowText.includes(searchText) ? "" : "none";
            });
        });


                console.log("üîç Adicionando eventos aos bot√µes...");
                adicionarEventosAosBotoes(); // Garante que os eventos s√£o adicionados ap√≥s a renderiza√ß√£o da tabela
            } catch (error) {
                console.error("‚ùå Erro ao carregar todos os pedidos:", error);
            }
        }
    
        // üîπ Executa a fun√ß√£o ao carregar a p√°gina
        window.onload = () => {
            carregarTodosOsPedidos();
        };
    
        function adicionarEventosAosBotoes() {
            const botoes = document.querySelectorAll(".action-btn");
    
            if (botoes.length === 0) {
                console.warn("‚ö†Ô∏è Nenhum bot√£o encontrado para adicionar eventos.");
                return;
            }
    
            botoes.forEach(btn => {
                console.log("üéØ Adicionando evento no bot√£o:", btn.dataset.id);
    
                btn.addEventListener("click", () => {
                    console.log("üîç Abrindo modal para pedido:", btn.dataset.id);
    
                    // Preenche os dados do modal com as informa√ß√µes do pedido
                    document.getElementById("modal-numero").textContent = btn.dataset.id;
                    document.getElementById("modal-nome").textContent = btn.dataset.name;
                    document.getElementById("modal-matricula").textContent = btn.dataset.matricula;
                    document.getElementById("modal-campus").textContent = btn.dataset.campus;
                    document.getElementById("modal-comida").textContent = btn.dataset.comida;
                    document.getElementById("modal-data").textContent = new Date(btn.dataset.date).toLocaleString("pt-BR");
    
                    // Salva o ID da compra no bot√£o "Fechar Pedido"
                    document.getElementById("close-order").setAttribute("data-id", btn.dataset.id);
    
                    // Exibe o modal removendo qualquer classe oculta
                    const modal = document.getElementById("modal");
                    modal.classList.add("visible");
                    modal.style.display = "block"; // Garante que o modal aparece
                });
            });
        }
    
        // üîπ Evento para fechar o modal ao clicar no bot√£o de fechar (X)
        document.getElementById("close-modal").addEventListener("click", () => {
            console.log("‚ùå Fechando modal.");
            const modal = document.getElementById("modal");
            modal.classList.remove("visible");
            modal.style.display = "none"; // Esconde o modal corretamente
        });
    
        // üîπ Evento para excluir um pedido ao clicar em "Fechar Pedido"
        document.getElementById("close-order").addEventListener("click", async () => {
            const compraId = document.getElementById("close-order").getAttribute("data-id");
    
            if (!compraId) {
                alert("‚ùå Erro: Nenhum pedido selecionado.");
                return;
            }
    
            try {
                const response = await fetch(`http://localhost:3000/buy/deletar-compra/${compraId}`, {
                    method: "DELETE"
                });
    
                if (!response.ok) {
                    throw new Error("Erro ao excluir pedido.");
                }
    
                const result = await response.json();
                console.log("üöÄ Pedido removido:", result);
    
                // Remove a linha correspondente da tabela
                const btn = document.querySelector(`button[data-id='${compraId}']`);
                if (btn) {
                    btn.closest("tr").remove();
                }
    
                // Fecha o modal
                const modal = document.getElementById("modal");
                modal.classList.remove("visible");
                modal.style.display = "none";
    
                alert("‚úÖ Pedido fechado com sucesso!");
            } catch (error) {
                console.error("‚ùå Erro ao fechar pedido:", error);
                alert("Erro ao fechar pedido.");
            }
        });
    </script>    
</body>
</html>